<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendario de Consultorios</title>
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" />
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700" />
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
      rel="stylesheet" />
    <script
      src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <link rel="stylesheet" href="../header/Header.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #calendar {
            max-width: 800px;
            margin: 20px auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        #sucursalSelector, #consultorioSelector {
            max-width: 300px;
            margin: 0 auto 20px;
        }
    </style>
  </head>
  <body>
    <header>
      <div class="header-blue">
        <nav
          class="navbar navbar-dark navbar-expand-md navigation-clean-search">
          <div class="container">
            <a class="navbar-brand" href="#">MediVida</a>
            <button class="navbar-toggler" data-toggle="collapse"
              data-target="#navcol-1">
              <span class="sr-only">Toggle navigation</span>
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navcol-1">
              <ul class="nav navbar-nav">
                <li class="nav-item"><a class="nav-link active"
                    href="#">Con√≥cenos</a></li>
                <li class="dropdown">
                  <a
                    class="dropdown-toggle nav-link dropdown-toggle"
                    data-toggle="dropdown" href="#">Redes
                    Sociales</a>
                  <div class="dropdown-menu">
                    <a class="dropdown-item"
                      href="#">Facebook</a>
                    <a class="dropdown-item"
                      href="#">Twitter</a>
                    <a class="dropdown-item"
                      href="#">Instagram</a>
                  </div>
                </li>
              </ul>
              <form class="form-inline mr-auto">
                <div class="form-group">
                  <label for="search-field"><i
                      class="fa fa-search"></i></label>
                  <input class="form-control search-field"
                    type="search" id="search-field" />
                </div>
              </form>
              <span class="navbar-text"><a href="#"
                  class="login">Iniciar Sesi√≥n</a></span>
              <a class="btn btn-light action-button"
                href="#">Registrarme</a>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <div class="container text-center mt-4">
      <h2>üóìÔ∏è Calendario de Consultorios</h2>
      <label for="sucursalSelector"><strong>Selecciona
          Sucursal:</strong></label>
      <select id="sucursalSelector" class="form-control mb-3">
        <option value="1">Sucursal 1</option>
        <option value="2">Sucursal 2</option>
      </select>
      <label for="consultorioSelector"><strong>Selecciona
          Consultorio:</strong></label>
      <select id="consultorioSelector" class="form-control mb-3">
        <!-- Opciones generadas din√°micamente -->
      </select>
      <button class="btn btn-success mb-3" data-toggle="modal"
        data-target="#modal-agregar-doctor">
        <i class="fa fa-user-md"></i> Agregar Doctor
      </button>
      <button class="btn btn-info mb-3" id="btn-ver-doctores"
        data-toggle="modal" data-target="#modal-ver-doctores">
        <i class="fa fa-users"></i> Ver Doctores
      </button>
    </div>

    <div id="calendar"></div>

    <!-- Modal de agregar doctor -->
    <div class="modal fade" id="modal-agregar-doctor" tabindex="-1"
      aria-labelledby="modalAgregarDoctorLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="form-agregar-doctor">
          <div class="modal-header">
            <h5 class="modal-title" id="modalAgregarDoctorLabel">Agregar
              Doctor</h5>
            <button type="button" class="close" data-dismiss="modal"
              aria-label="Cerrar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="nombre-doctor">Nombre(s)</label>
              <input type="text" class="form-control" id="nombre-doctor"
                required>
            </div>
            <div class="form-group">
              <label for="apep-doctor">Apellido Paterno</label>
              <input type="text" class="form-control" id="apep-doctor" required>
            </div>
            <div class="form-group">
              <label for="apem-doctor">Apellido Materno</label>
              <input type="text" class="form-control" id="apem-doctor">
            </div>
            <div class="form-group">
              <label for="curp-doctor">CURP</label>
              <input type="text" class="form-control" id="curp-doctor"
                maxlength="18" required>
            </div>
            <div class="form-group">
              <label for="rfc-doctor">RFC</label>
              <input type="text" class="form-control" id="rfc-doctor"
                maxlength="13" required>
            </div>
            <div class="form-group">
              <label for="telefono-doctor">Tel√©fono</label>
              <input type="text" class="form-control" id="telefono-doctor"
                maxlength="10" required>
            </div>
            <div class="form-group">
              <label for="fecha-nacimiento-doctor">Fecha de Nacimiento</label>
              <input type="date" class="form-control"
                id="fecha-nacimiento-doctor" required>
            </div>
            <div class="form-group">
              <label for="especialidad-doctor">Especialidad</label>
              <select class="form-control" id="especialidad-doctor" required>
                <option value>Selecciona una especialidad</option>
              </select>
            </div>
            <div class="form-group">
              <label for="correo-doctor">Correo</label>
              <input type="email" class="form-control" id="correo-doctor"
                required>
            </div>
            <div class="form-group">
              <label for="contrasena-doctor">Contrase√±a</label>
              <input type="password" class="form-control" id="contrasena-doctor"
                required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary"
              data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Agregar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para asignar doctor a horario (Bootstrap 4.1.3) -->
    <div class="modal fade" id="modal-asignar-doctor" tabindex="-1"
      role="dialog" aria-labelledby="modalAsignarDoctorLabel"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <form id="form-asignar-doctor">
            <div class="modal-header bg-info text-white">
              <h5 class="modal-title" id="modalAsignarDoctorLabel">
                <i class="fa fa-user-md"></i> Asignar Doctor a Horario
              </h5>
              <button type="button" class="close text-white"
                data-dismiss="modal" aria-label="Cerrar">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div id="info-horario" class="mb-3"></div>
              <div class="form-group">
                <label for="select-doctor">Selecciona Doctor</label>
                <select class="form-control" id="select-doctor" required>
                  <!-- Opciones generadas din√°micamente -->
                </select>
              </div>
            </div>
            <div class="modal-footer bg-light">
              <button type="button" class="btn btn-secondary"
                data-dismiss="modal">
                <i class="fa fa-times"></i> Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fa fa-check"></i> Asignar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para ver doctores (Bootstrap 4.1.3, tabla grande) -->
    <div class="modal fade" id="modal-ver-doctores" tabindex="-1" role="dialog"
      aria-labelledby="modalVerDoctoresLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl" role="document"
        style="max-width:98vw;">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalVerDoctoresLabel">
              <i class="fa fa-users"></i> Lista de Doctores
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal"
              aria-label="Cerrar" style="font-size:2rem;">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body p-0">
            <div class="table-responsive">
              <table
                class="table table-hover table-bordered align-middle mb-0 table-sm"
                style="font-size: 0.97rem;">
                <thead class="thead-dark">
                  <tr>
                    <th>Nombre(s)</th>
                    <th>Apellido Paterno</th>
                    <th>Apellido Materno</th>
                    <th>CURP</th>
                    <th>RFC</th>
                    <th>Tel√©fono</th>
                    <th>Fecha de Nacimiento</th>
                    <th>Especialidad</th>
                    <th>Correo</th>
                  </tr>
                </thead>
                <tbody id="tabla-doctores">
                  <!-- Aqu√≠ se insertan los doctores -->
                </tbody>
              </table>
            </div>
            <div id="sin-doctores" class="text-center text-muted py-5"
              style="display:none;">
              <i class="fa fa-user-md fa-3x mb-3 text-primary"></i>
              <div class="h5">No hay doctores registrados.</div>
            </div>
          </div>
          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-outline-primary"
              data-dismiss="modal">
              <i class="fa fa-times"></i> Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de citas Bootstrap -->
    <div class="modal fade" id="modal-citas" tabindex="-1"
      aria-labelledby="modalCitasLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalCitasLabel">Citas del
              D√≠a</h5>
            <button type="button" class="close" data-dismiss="modal"
              aria-label="Cerrar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <ul id="lista-citas" class="list-group"></ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger btn-sm"
              data-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.bundle.min.js"></script>

  </body>
</html>

<script>
// Llenar especialidades al abrir el modal de agregar doctor
function cargarEspecialidades() {
    fetch('../../Backend/admin.php?accion=get_especialidades')
        .then(r => r.json())
        .then(resp => {
            const select = document.getElementById('especialidad-doctor');
            select.innerHTML = '<option value="">Selecciona una especialidad</option>';
            if (resp.success) {
                resp.data.forEach(esp => {
                    const option = document.createElement('option');
                    option.value = esp.id;
                    option.textContent = esp.nombre;
                    select.appendChild(option);
                });
            }
        });
}
$('#modal-agregar-doctor').on('show.bs.modal', cargarEspecialidades);

// Llenar tabla de doctores al abrir el modal de ver doctores
function cargarDoctores() {
    fetch('../../Backend/admin.php?accion=get_doctores')
        .then(r => r.json())
        .then(resp => {
            const tabla = document.getElementById('tabla-doctores');
            const sinDoctores = document.getElementById('sin-doctores');
            tabla.innerHTML = '';
            if (!resp.success || !resp.data || resp.data.length === 0) {
                sinDoctores.style.display = 'block';
            } else {
                sinDoctores.style.display = 'none';
                resp.data.forEach(doc => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${doc.Nombre}</td>
                        <td>${doc.Ape_Pa}</td>
                        <td>${doc.Ape_Ma}</td>
                        <td>${doc.CURP}</td>
                        <td>${doc.RFC}</td>
                        <td>${doc.Telefono}</td>
                        <td>${doc.Fecha_Nacimiento}</td>
                        <td>${doc.especialidad}</td>
                        <td>${doc.Correo}</td>
                    `;
                    tabla.appendChild(tr);
                });
            }
        });
}
document.getElementById('btn-ver-doctores').addEventListener('click', cargarDoctores);

// Llenar select de doctores reales al abrir el modal de asignar doctor
function llenarSelectDoctores() {
    fetch('../../Backend/admin.php?accion=get_doctores')
        .then(r => r.json())
        .then(resp => {
            const select = document.getElementById('select-doctor');
            select.innerHTML = '';
            if (resp.success && resp.data.length > 0) {
                resp.data.forEach((doc) => {
                    const option = document.createElement('option');
                    option.value = doc.Correo;
                    option.textContent = `${doc.Nombre} ${doc.Ape_Pa} ${doc.Ape_Ma} - ${doc.especialidad}`;
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay doctores disponibles';
                select.appendChild(option);
            }
        });
}
$('#modal-asignar-doctor').on('show.bs.modal', llenarSelectDoctores);

// Llenar sucursales al cargar la p√°gina
function llenarSucursales() {
    fetch('../../Backend/admin.php?accion=get_sucursales')
        .then(r => r.json())
        .then(resp => {
            const select = document.getElementById('sucursalSelector');
            select.innerHTML = '';
            if (resp.success && resp.data.length > 0) {
                resp.data.forEach(suc => {
                    const option = document.createElement('option');
                    option.value = suc.ID;
                    option.textContent = suc.Nombre;
                    select.appendChild(option);
                });
                // Llenar consultorios de la primera sucursal
                llenarConsultorios(select.value);
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay sucursales';
                select.appendChild(option);
            }
        });
}

// Llenar consultorios seg√∫n sucursal seleccionada
function llenarConsultorios(sucursalId) {
    fetch(`../../Backend/admin.php?accion=get_consultorios&sucursal=${sucursalId}`)
        .then(r => r.json())
        .then(resp => {
            const select = document.getElementById('consultorioSelector');
            select.innerHTML = '';
            if (resp.success && resp.data.length > 0) {
                resp.data.forEach(num => {
                    const option = document.createElement('option');
                    option.value = num;
                    option.textContent = `Consultorio ${num}`;
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay consultorios';
                select.appendChild(option);
            }
        });
}

// Al cambiar sucursal, llenar consultorios
document.addEventListener('DOMContentLoaded', function () {
    llenarSucursales();
    document.getElementById('sucursalSelector').addEventListener('change', function () {
        llenarConsultorios(this.value);
    });
});

// Registrar doctor
function enviarRegistroDoctor(e) {
    e.preventDefault();

    const data = {
        accion: 'registrar_doctor',
        nombre: document.getElementById('nombre-doctor').value,
        apep: document.getElementById('apep-doctor').value,
        apem: document.getElementById('apem-doctor').value,
        curp: document.getElementById('curp-doctor').value,
        rfc: document.getElementById('rfc-doctor').value,
        telefono: document.getElementById('telefono-doctor').value,
        fecha_nacimiento: document.getElementById('fecha-nacimiento-doctor').value,
        especialidad_id: document.getElementById('especialidad-doctor').value,
        correo: document.getElementById('correo-doctor').value,
        contrasena: document.getElementById('contrasena-doctor').value
    };

    fetch('../../Backend/admin.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(resp => {
        if (resp.success) {
            alert('Doctor registrado correctamente');
            $('#modal-agregar-doctor').modal('hide');
            document.getElementById('form-agregar-doctor').reset();
        } else {
            alert('Error: ' + resp.message);
        }
    })
    .catch(() => alert('Error al registrar doctor'));
}
document.getElementById('form-agregar-doctor').addEventListener('submit', enviarRegistroDoctor);

// Generar horas del d√≠a
const generarHorasDelDia = () => {
  const horas = [];
  for (let i = 8; i <= 20; i++) {
    const hora = i.toString().padStart(2, '0') + ":00";
    horas.push(hora);
  }
  return horas;
};

// Formatear hora tipo "08:00" a "8:00 AM"
function formatearHoraAMPM(hora24) {
    let [hora, minutos] = hora24.split(':').map(Number);
    const ampm = hora >= 12 ? 'PM' : 'AM';
    hora = hora % 12 || 12;
    return `${hora}:${minutos.toString().padStart(2, '0')} ${ampm}`;
}

document.addEventListener('DOMContentLoaded', function () {
  const calendarEl = document.getElementById('calendar');
  const sucursalSelector = document.getElementById('sucursalSelector');
  const consultorioSelector = document.getElementById('consultorioSelector');

  // Funci√≥n para manejar el click en el calendario
  function handleDateClick(info) {
    const sucursal = sucursalSelector.value;
    const consultorio = consultorioSelector.value;
    const fecha = info.dateStr;

    // Obtener horarios ocupados desde el backend (con nombre del doctor)
    fetch(`../../Backend/admin.php?accion=get_horarios_ocupados&sucursal=${sucursal}&consultorio=${consultorio}&fecha=${fecha}`)
      .then(r => r.json())
      .then(resp => {
        let ocupados = [];
        let ocupadosPorDoctor = {};
        if (resp.success && Array.isArray(resp.data)) {
          ocupados = resp.data.map(h => h.hora);
          resp.data.forEach(h => {
            ocupadosPorDoctor[h.hora] = h.doctor;
          });
        }

        const lista = document.getElementById('lista-citas');
        lista.innerHTML = '';
        const horas = generarHorasDelDia();

        horas.forEach(hora => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          const horaFormateada = formatearHoraAMPM(hora);

          if (!ocupados.includes(hora)) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-success btn-sm';
            btn.textContent = `${horaFormateada}: Disponible`;
            btn.onclick = function() {
              window.horarioSeleccionado = {
                sucursal,
                consultorio,
                fecha,
                hora
              };
              document.getElementById('info-horario').textContent = `Horario: ${horaFormateada} - ${fecha}`;
              document.body.focus();
              $('#modal-citas').modal('hide');
              $('#modal-citas').on('hidden.bs.modal', function () {
                $('#modal-asignar-doctor').modal('show');
                $('#modal-citas').off('hidden.bs.modal');
              });
            };
            li.appendChild(btn);
          } else {
            li.textContent = `${horaFormateada}: Ocupado por ${ocupadosPorDoctor[hora]}`;
            li.classList.add('text-primary');
          }
          lista.appendChild(li);
        });

        $('#modal-citas').modal('show');
      });
  }

  // Inicializa el calendario con eventos ocupados y nombre del doctor
 let calendar = new FullCalendar.Calendar(calendarEl, {
  initialView: 'dayGridMonth',
  events: function(fetchInfo, successCallback, failureCallback) {
    const sucursal = sucursalSelector.value;
    const consultorio = consultorioSelector.value;
    fetch(`../../Backend/admin.php?accion=get_eventos_calendario&sucursal=${sucursal}&consultorio=${consultorio}`)
      .then(r => r.json())
      .then(data => successCallback(data))
      .catch(failureCallback);
  },
  dateClick: handleDateClick
});

  calendar.render();

  // Asignar doctor a horario
  document.getElementById('form-asignar-doctor').addEventListener('submit', function(e) {
    e.preventDefault();
    const doctorCorreo = document.getElementById('select-doctor').value;
    const doctorNombre = document.getElementById('select-doctor').selectedOptions[0].textContent;
    const { sucursal, consultorio, fecha, hora } = window.horarioSeleccionado;

    fetch('../../Backend/admin.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        accion: 'asignar_horario_doctor',
        doctor_correo: doctorCorreo,
        sucursal: sucursal,
        consultorio: consultorio,
        fecha: fecha,
        hora: hora
      })
    })
    .then(r => r.json())
    .then(resp => {
      if (resp.success) {
        $('#modal-asignar-doctor').modal('hide');
        calendar.refetchEvents();
        alert('Horario asignado correctamente');
      } else {
        alert('Error: ' + resp.message);
      }
    })
    .catch(() => alert('Error al asignar horario'));
  });

  // Cambiar consultorios al cambiar sucursal
  sucursalSelector.addEventListener('change', function () {
    llenarConsultorios(this.value);
    calendar.refetchEvents();
  });

  // Cambiar eventos al cambiar consultorio
  consultorioSelector.addEventListener('change', function () {
    calendar.refetchEvents();
  });
});
</script>